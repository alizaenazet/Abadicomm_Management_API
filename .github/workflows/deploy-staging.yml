name: Deploy Staging

on:
  push:
    branches: [ "staging" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # 1. Ambil Source Code
    - uses: actions/checkout@v4

    # 2. Setup Node.js untuk Build Vite
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    # 3. Install & Build Assets
    - name: Install & Build Vite
      run: |
        npm ci
        npm run build
      # Catatan: Pastikan .env tidak diperlukan saat build, 
      # atau inject env vars yang diperlukan Vite di sini.

    # 4. Kirim Folder 'public/build' ke Server via SCP
    # Kita pakai appleboy/scp-action yang populer & stabil
    - name: Copy Build Artifacts to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        # Kirim folder lokal 'public/build' ke folder server
        source: "public/build"
        target: "/opt/stack/apps/management-abadicomm/staging/public"
        strip_components: 2 # Agar strukturnya pas (opsional, sesuaikan tes nanti)

    # 5. Eksekusi Perintah di Server via SSH
    - name: Execute Remote Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        script: |
          echo "A. Masuk ke Folder Project"
          cd /opt/stack/apps/management-abadicomm/staging

          echo "B. Tarik Kode PHP Terbaru"
          git pull origin staging

          echo "C. Restart Container (Update Image & anonymous volumes)"
          echo "Give containers time to finish requests"
          docker compose -f docker-compose-staging.yml stop --timeout 30
          echo "Then rebuild and start"
          docker compose -f docker-compose-staging.yml up -d --build

          echo "D. Laravel Maintenance Tasks (Jalan di dalam Container)"
          echo "Asumsi nama service di docker-compose adalah 'app'"
          echo "Asumsi nama container (container_name) adalah 'management-abadicomm-staging'"
          
          echo "Running Migrations..."
          docker exec management-abadicomm-staging php artisan migrate --force

          echo "Fixing Permissions..."
          sudo chown -R www-data:www-data public/build
          sudo chmod -R 755 public/build
          chmod -R 777 storage
          chmod -R 777 bootstrap/cache